<!-- views/account/management.ejs -->
<div class="account-page">
  <h1 class="account-title"><%= title %></h1>

  <% if (errors) { %>
    <ul class="error">
      <% if (typeof errors.array === 'function') { 
           errors.array().forEach(error => { %>
             <li><%= error.msg %></li>
      <%   })
         } else if (Array.isArray(errors)) {
           errors.forEach(err => { %>
             <li><%= err.msg || err %></li>
      <%   })
         } %>
    </ul>
  <% } %>

  <div class="account-body">
    <div class="account-head">
      <!-- Greeting: always show first name -->
      <% if (account && account.account_firstname) { %>
        <h2>Welcome <%= account.account_firstname %></h2>
      <% } else { %>
        <h2>Account Overview</h2>
      <% } %>

      <div class="account-actions">
        <% if (account && account.account_id) { %>
          <a href="/account/edit/<%= account.account_id %>" class="btn-secondary">Update account information</a>
          <a href="/account/messages/inbox" class="btn">Inbox (<%= typeof inboxCount !== 'undefined' ? inboxCount : 0 %>)</a>
          <a href="/account/messages/outbox" class="btn">Sent</a>
        <% } %>

        <!-- show Logout only as a form (already in header); keep a fallback here if needed -->
        <form action="/account/logout" method="post" style="display:inline; margin-left:8px;">
          <button class="btn-logout" type="submit">Logout</button>
        </form>
      </div>
    </div>

    <!-- If Employee or Admin show Inventory Management link -->
    <% if (account && (account.account_type === "Employee" || account.account_type === "Admin")) { %>
      <h3>Inventory Management</h3>
      <p><a href="/inv/">Go to Inventory Management</a></p>
    <% } %>

    <div class="account-details">
      <% if (account) { %>
        <p><span class="label">Name:</span> <strong><%= account.account_firstname %> <%= account.account_lastname %></strong></p>
        <p><span class="label">Email:</span> <%= account.account_email %></p>
        <p><span class="label">Account Type:</span> <%= account.account_type %></p>
      <% } else { %>
        <p>You are not logged in.</p>
      <% } %>
    </div>

    <!-- User Reviews -->
    <section class="user-reviews" style="margin-top:18px;">
      <% if (reviews && reviews.length) { %>
        <h3>Your Reviews</h3>
        <ul class="card" style="padding:12px; list-style:none;">
          <% reviews.forEach(r => { %>
            <li style="margin-bottom:14px; border-bottom:1px solid rgba(15,23,42,0.04); padding-bottom:12px;">
              <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
                <div>
                  <strong><%= r.inv_make %> <%= r.inv_model %></strong>
                  <div class="text-muted" style="font-size:0.95rem;">Rating: <%= r.rating %> â€” <%= new Date(r.created_at).toLocaleString() %></div>
                  <p style="margin-top:8px;"><%= r.comment %></p>
                </div>

                <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                  <a href="/reviews/edit/<%= r.review_id %>" class="btn" aria-label="Edit review">Edit</a>

                  <form class="review-delete-form" action="/reviews/delete" method="post" style="display:inline;">
                    <input type="hidden" name="review_id" value="<%= r.review_id %>">
                    <button class="btn review-delete-btn" type="submit" aria-label="Delete review">Delete</button>
                  </form>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>

        <!-- pagination -->
        <% if (typeof reviewsPagination !== 'undefined' && reviewsPagination.totalPages > 1) { %>
          <nav class="pagination" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <% if (reviewsPagination.page > 1) { %>
              <a class="btn" href="?page=<%= reviewsPagination.page - 1 %>">Previous</a>
            <% } %>
            <span>Page <%= reviewsPagination.page %> of <%= reviewsPagination.totalPages %></span>
            <% if (reviewsPagination.page < reviewsPagination.totalPages) { %>
              <a class="btn" href="?page=<%= reviewsPagination.page + 1 %>">Next</a>
            <% } %>
          </nav>
        <% } %>

      <% } else { %>
        <p class="text-muted">You have not posted any reviews yet.</p>
      <% } %>
    </section>

    <div class="account-links" style="margin-top:18px;">
      <a href="/">Back to Home</a>
      <a href="/account/change-password">Change password</a>
    </div>
  </div>
</div>

<!-- include client-side confirmation script just for this page -->
<script src="/js/account-reviews.js"></script>
