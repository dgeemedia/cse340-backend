<!-- views/messages/view.ejs -->
<div class="container">
  <h1>Message</h1>

  <div class="card" style="padding:14px; max-width:840px;">
    <p><strong>From:</strong> <%= message.sender_first || 'System' %> <%= message.sender_last || '' %></p>
    <p><strong>To:</strong> <%= message.recipient_first || '' %> <%= message.recipient_last || '' %></p>
    <p><strong>Subject:</strong> <%= message.subject || '(no subject)' %></p>
    <p><strong>Date:</strong> <%= new Date(message.created_at).toLocaleString() %></p>
    <hr>
    <div style="white-space:pre-wrap;"><%= message.body %></div>
  </div>

  <p style="margin-top:12px;">
    <a href="/account/messages/inbox" class="btn">Back to inbox</a>
  </p>

<% if (message && typeof accountData !== 'undefined' && accountData && accountData.account_id) { %>
  <h3 style="margin-top:18px;">Reply</h3>

  <!-- Reply toggle button -->
  <div style="margin-bottom:8px;">
    <button id="msg-reply-toggle" class="btn">Reply to this message</button>
  </div>

  <!-- Hidden reply form -->
  <div id="msg-reply-wrap" style="display:none; max-width:720px;">
    <form id="msg-reply-form" action="/account/messages/send" method="post" class="account-form" style="max-width:720px;">
      <input type="hidden" name="recipient_id" value="<%= (accountData.account_id === message.recipient_id) ? message.sender_id : message.recipient_id %>">
      <div class="form-row">
        <label for="subject">Subject</label>
        <input id="subject" name="subject" type="text" value="Re: <%= message.subject || '' %>">
      </div>
      <div class="form-row">
        <label for="body">Message</label>
        <textarea id="msg-body" name="body" rows="5" required placeholder="Write your reply..."></textarea>
        <div class="muted" style="font-size:0.85rem; margin-top:6px;">Press Enter to send, Shift+Enter for newline.</div>
      </div>
      <div class="form-row" style="display:flex; gap:10px; align-items:center;">
        <button class="btn-primary" type="submit">Send Reply</button>
        <button id="msg-reply-cancel" type="button" class="btn">Cancel</button>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const toggle = document.getElementById('msg-reply-toggle')
      const wrap = document.getElementById('msg-reply-wrap')
      const form = document.getElementById('msg-reply-form')
      const textarea = document.getElementById('msg-body')
      const cancel = document.getElementById('msg-reply-cancel')

      if (toggle && wrap) {
        toggle.addEventListener('click', () => {
          wrap.style.display = (wrap.style.display === 'none' || wrap.style.display === '') ? 'block' : 'none'
          if (wrap.style.display === 'block' && textarea) textarea.focus()
        })
      }
      if (cancel) {
        cancel.addEventListener('click', () => { wrap.style.display = 'none' })
      }

      // Submit on Enter (Shift+Enter => newline)
      if (textarea && form) {
        textarea.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' && !ev.shiftKey) {
            ev.preventDefault()
            form.requestSubmit ? form.requestSubmit() : form.submit()
          }
        })
      }
    })()
  </script>
<% } %>

